<!DOCTYPE html>
<html>
<head>
  <title>Birdee</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link href='http://fonts.googleapis.com/css?family=Biryani:400,800,900|Nunito:400,700' rel='stylesheet' type='text/css'>
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/extra.css" rel="stylesheet" media="screen">
  <style>
  html, body, #map-canvas {
    height: 800 px;
    padding: 0;

  }

  body {
    background: #accbe8 url("/img/half-tree.png") no-repeat fixed right;
  }

  .center {
    margin: auto;
    width: 100%;
  }

  </style>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>

  <script>
  // Note: This example requires that you consent to location sharing when
  // prompted by your browser. If you see a blank space instead of the map, this
  // is probably because you have denied permission for location sharing.

  $(document).ready(function(){
    $("#myBtn").click(function(event){
      event.preventDefault();
      //var x = $("#selected").val();
      var x = $("#selected").val();
      $("#demo").innerHTML = x;
      initialize();
      search(x);
    });
  });

  var map;
  var pos;
  var infowindow;
  var service;

  function initialize() {
    var mapOptions = {
      zoom: 15
    };
    map = new google.maps.Map(document.getElementById('map-canvas'),
    mapOptions);

    // Try HTML5 geolocation
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        pos = new google.maps.LatLng(position.coords.latitude,
          position.coords.longitude);

          /*var request = {
          location: pos,
          radius: 1000,
          types: ['store']
        };*/
        map.setCenter(pos);
        var marker=new google.maps.Marker({
          position:pos,
          icon: {
            // Star
            path: 'M 0,-24 6,-7 24,-7 10,4 15,21 0,11 -15,21 -10,4 -24,-7 -6,-7 z',
            fillColor: '#ffff00',
            fillOpacity: 1,
            scale: 1/4,
            strokeColor: '#bd8d2c',
            strokeWeight: 1
          }
        });

        marker.setMap(map);
      }, function() {
        handleNoGeolocation(true);
      });
    } else {
      // Browser doesn't support Geolocation
      handleNoGeolocation(false);
    }
  }

  function handleNoGeolocation(errorFlag) {
    if (errorFlag) {
      var content = 'Error: The Geolocation service failed.';
    } else {
      var content = 'Error: Your browser doesn\'t support geolocation.';
    }

    var options = {
      map: map,
      position: new google.maps.LatLng(60, 105),
      content: content
    };

    var infowindow = new google.maps.InfoWindow(options);
    map.setCenter(options.position);
  }
  google.maps.event.addDomListener(window, 'load', initialize);

  </script>
</head>
<body bgcolor="#accbe8">
  <div class="container">
    <header class="page-header">
      <h1><b>Birdee   </b> <small><i>  travel made easy</i></small></h1>
    </header>
    <div class="dropdown center">
      <h3><small>What are you looking for?</small></h3>
      <select name="What are you looking for?" id="selected">
        <option value="lodging">Lodging</option>
        <option value="food">Food</option>
        <option value="airport">Airport</option>
        <option value="hotel">Hotel</option>
        <option value="atm">ATM</option>
        <option value="bank">Bank</option>
        <option value="bus_station">Bus Station</option>
        <option value="taxi_stand">Taxi</option>
        <option value="train_stand">Train</option>
        <option value="cafe">Cafe</option>
        <option value="gas_station">Gas Station</option>
        <option value="clothing_store">Clothing</option>
      </select>
      <input type="submit" id="myBtn" value="Submit" class="btn btn-success btn-sm">
      <p id="demo"></p>
    </div>
    <br>

    </div>
      <script>
      </script>
      <script>
      var map;
      var pos;
      var infowindow;
      function search(text) {
        var mapOptions = {
          zoom: 15
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position){
            pos = new google.maps.LatLng(position.coords.latitude,
              position.coords.longitude);
            }
          );

          var request = {
            location: pos,
            radius: 7500, //1000 m
            types: [String(text)]
          };

          infowindow = new google.maps.InfoWindow();
          service = new google.maps.places.PlacesService(map);

          /********* IMPORTANT ********/
          service.nearbySearch(request, callback);
          /********* IMPORTANT ********
          replace with

          var request = {
            placeId: 'insert id here'
          };

          service.getDetails(request,callback);

          function callback(place, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
              createMarker(place);
            }
          }
           */
        }

        else {
          handleNoGeolocation(false);
        }
      }

      function createMarker(place) {
        var placeLoc = place.geometry.location;

        var image = {
          url: place.icon,
          size: new google.maps.Size(71, 71),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(17, 34),
          scaledSize: new google.maps.Size(25, 25)
        };

        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location,
          icon: image,
          /*place: {
            placeId: place.place_id,
            location: place.geometry.location
          }*/
          placeId: place.place_id
        });
        marker.setMap(map);

        /*var id_request = {
          placeId: place.placeId;
        }

        service = new google.maps.places.PlacesService(map);
        service.getDetails(id_request, callback);*/

        //var location = String(place.geometry.location);
        //var ary = location.split(/(|)/);

/*
        // This event expects a click on a marker
        // When this event is fired the Info Window is opened.
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map,marker);
        });

        // Event that closes the Info Window with a click on the map
        google.maps.event.addListener(map, 'click', function() {
          infowindow.close();
        });*/




        var contentString = '<div style="margin-top:0.37em;margin-bottom:0.37em"<h1 style="font-size:90%"><b>'+place.name+'</b></h1>'
          +'<p style="margin-top:0.37em;margin-bottom:0.37em"><b>Address: </b>'+place.vicinity+'</p>'
          +'<p style="margin-top:0.37em;margin-bottom:0.37em"><b>Rating: </b>'+place.rating+'/5.0</p></div>'
        //  +'<p style="margin-top:0.37em;margin-bottom:0.37em"><b>Place ID: </b>'+place.place_id+'</p></div>';
        //  +'<p style="margin-top:0.37em;margin-bottom:0.37em;text-alignment:center"><a href = "https://maps.google.com?saddr=Current+Location&daddr='+ary[2]+'">Click for Directions</a></p></div>';

          google.maps.event.addListener(marker, 'click', function() {
          //google.maps.event.addListener(infowindow, 'domready', function() {
          infowindow.setContent(contentString);
          /*
          //customization
          // Reference to the DIV that wraps the bottom of infowindow
          var iwOuter = $('.gm-style-iw');

          /* Since this div is in a position prior to .gm-div style-iw.
           * We use jQuery and create a iwBackground variable,
           * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
          */
        /*  var iwBackground = iwOuter.prev();

          // Removes background shadow DIV
          iwBackground.children(':nth-child(2)').css({'display' : 'none'});

          // Removes white background DIV
          iwBackground.children(':nth-child(4)').css({'display' : 'none'});

          // Moves the infowindow 115px to the right.
          iwOuter.parent().parent().css({left: '115px'});

          // Moves the shadow of the arrow 76px to the left margin.
          iwBackground.children(':nth-child(1)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

          // Moves the arrow 76px to the left margin.
          iwBackground.children(':nth-child(3)').attr('style', function(i,s){ return s + 'left: 76px !important;'});

          // Changes the desired tail shadow color.
          iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});

          // Reference to the div that groups the close button elements.
          var iwCloseBtn = iwOuter.next();

          // Apply the desired effect to the close button
          iwCloseBtn.css({opacity: '1', right: '38px', top: '3px', border: '7px solid #48b5e9', 'border-radius': '13px', 'box-shadow': '0 0 5px #3990B9'});

          // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
          if($('.iw-content').height() < 140){
            $('.iw-bottom-gradient').css({display: 'none'});
          }

          // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
          iwCloseBtn.mouseout(function(){
            $(this).css({opacity: '1'}); */

          infowindow.open(map, this);
        });
      }

      function callback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            //createMarker(results[i]);

            /* SOMEWHERE HERE IS A BUG?*/
            var service = new google.maps.places.PlacesService(map); //delete var?
            var place = results[i];
            service.getDetails({
              placeId: place.place_id
            }, function(place, status) {
              if (status === google.maps.places.PlacesServiceStatus.OK) { //three equals
                createMarker(place);
              }
            });
          }
        }
      }


      function loadScript() {
        var script = document.createElement("script");
        script.src = "http://maps.googleapis.com/maps/api/js?callback=initialize";
        document.body.appendChild(script);
      }

      // window.onload = loadScript;
      </script>
      <div class="container" id="map-canvas"></div>
  </body>
  </html>
